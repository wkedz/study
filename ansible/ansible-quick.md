# Ansible quick guide

## Instalation

### Install helpfull utilities:

`apt install software-properties-common`

### Add ansible repo:

`apt-add-repository --yes --update ppa:ansible/ansible`

### Ansible inventory file (the one that contains list of hosts):

`/etc/ansible/hosts`

### Ansible invetory variables

https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#connecting-to-hosts-behavioral-inventory-parameters

### Ansible config file (can be generated with disabled arguments):

`ansible-config init --disabled -t all >/etc/ansible/ansible.cfg`

## Using modules

### Example

`ansible all -a 'uptime'` is same as 

`ansible all -m command -a 'uptime'`

`ansible HOST -m MODULE -a "MODULE ARGS"`

`ansible wrk1 -m copy -a 'src=/home/dev/file dest=/tmp/file'`

## Offline documentation 

### List all packages 

`ansible-doc -l`

### More info about target module (ex. package)

`ansible-doc package`

## Ansible facts and magic variables

### Ansible facts 

Are information gathered by ansible about target machine 

`ansible host -m setup`

Its called every time before calling playbook. 

More info:

https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_vars_facts.html#ansible-facts

### Ansible magic variables  

Are information regarding ansible itself.

`ansible host -m debug -a 'var=groups'`

More info:

https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_vars_facts.html#information-about-ansible-magic-variables

### Geting variables inside playbook

Single variable:

```
var : var | {{ var }} | "{{ var }} STRING"
```

List of variables:
```
var_list: | {{var_list[0]}}
  - a
  - b
```

Dict with variables:
```
var_dict: | {{ var_dict ["a"] }} | {{ var_dict.a }}
  a: b
  c: d
```
### Splitting variables per hosts / groups 

https://docs.ansible.com/ansible/latest/inventory_guide/intro_inventory.html#inventory-basics-formats-hosts-and-groups

A basic INI /etc/ansible/hosts might look like this:

```
mail.example.com

[webservers]
foo.example.com
bar.example.com
www[01:50].example.com:

[dbservers]
one.example.com
two.example.com
three.example.com

[local]
local ansible_connection=local

Here’s that same basic inventory file in YAML format:

all:
  hosts:
    mail.example.com:
  children:
    webservers:
      hosts:
        foo.example.com:
        bar.example.com:
        www[01:50:2].example.com:
    dbservers:
      hosts:
        one.example.com:
        two.example.com:
        three.example.com:


```

Directory: 

```
hosts_vars - is directory with variables for target hosts
hosts_vars/web0 - variables for web0,
hosts_vars/web1 - variables for web1,
hosts_vars/web2 - variables for web2,
hosts_vars/db0 - variables for db0,
hosts_vars/db1 - variables for db1.

group_vars - is directory with variables for target groups
group_vars/webs - variables for web group,
group_vars/dbs  - variables for db group,
group_vars/all  - variables for all groups.
```

Or by target file inside playbook:

`vars_files:`

## Playbooks

https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_intro.html

Simple Example:

```
# main.yaml
- name: Generate locally SSH keys for users
  hosts: local
  tasks:

    - name: "Generate SSH key for ssh_users"
      openssh_keypair:
        path: "/root/playbook/ssh_keys/{{ item }}"
        type: ed25519
        state: present
        comment: "{{ item }} generated by ansible"
      loop: "{{ ssh_user }}"

- name: Tasks for webs and dbs
  hosts: webs,dbs
  tasks:

    - name: Add users
      user:
        name: "{{ item }}"
        comment: "User {{ item }}"
        shell: /bin/bash
      loop: "{{ ssh_user }}"

    - name: Add authorized_keys for users
      authorized_key:
        user: "{{ item }}"
        state: present
        key: "{{ lookup('file', '/root/playbook/ssh_keys/' + item + '.pub') }}"
      loop: "{{ ssh_user }}"

    - name: firewall CentoOS
      include_tasks: firewall_centos.yaml
      when: ansible_facts['os_family'] == "RedHat"
      tags: firewall

    - name: firewall Ubuntu
      include_tasks: firewall_ubuntu.yaml
      when: ansible_facts['os_family'] == "Debian"
      tags: firewall
```
Another:

```
# firewall_centos.yaml
- name: permit traffic in default zone
  firewalld:
    port: "{{ item }}/tcp"
    permanent: yes
    state: enabled
    immediate: true
  loop: "{{ open_ports }}"
  tags: firewall

# firewall_ubuntu.yaml
- name: allow open ports
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: "{{ open_ports }}"
  tags: firewall

- name: Default policy to deny and enable ufw
  ufw:
    state: enabled
    policy: deny
  tags: firewall
```

## Handlers

Homepage:

https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html#handlers

Sometimes you want a task to run only when a change is made on a machine. For example, you may want to restart a service if a task updates the configuration of that service, but not if the configuration is unchanged. Ansible uses handlers to address this use case. Handlers are tasks that only run when notified.

In this example playbook, the Apache server is restarted by the handler after all tasks complete in the play.

```
---
- name: Verify apache installation
  hosts: webservers
  vars:
    http_port: 80
    max_clients: 200
  remote_user: root
  tasks:
    - name: Ensure apache is at the latest version
      ansible.builtin.yum:
        name: httpd
        state: latest

    - name: Write the apache config file
      ansible.builtin.template:
        src: /srv/httpd.j2
        dest: /etc/httpd.conf
      notify:
      - Restart apache

    - name: Ensure apache is running
      ansible.builtin.service:
        name: httpd
        state: started

  handlers:
    - name: Restart apache
      ansible.builtin.service:
        name: httpd
        state: restarted
```

## Galaxy and Roles

Homepage:

https://galaxy.ansible.com/home

To install role use:

ansible-galaxy install ROLE_NAME -p /etc/ansible/roles

where: 
* -p - will install role to target path, in this case it will install it globally, without it, it would be installed in user homedir. 

`Roles` are executed before `tasks`. To run `task` before role, you need to use `pre_task`

Example: 

```
- name: Role for web
  hosts: web
  pre_tasks:
    - name: Test message
      debug:
        msg: "test"
      tags: docker
  roles:
    - { role: 'geerlingguy.docker', tags: 'docker' }  #tag for tole need to be inside curly bracket
    
  tasks:
  
    - name: Install required packages 
      apt:
        pkg:
          - python3-pip
          - python3-setuptools
        state: latest
        update_cache: true
      tags: docker_run
      
    - name: Install docker python module  # Ansible is using pythons docker image, so we need to install it first.
      pip:
        name: docker
      tags: docker_run
      
    - name: Pull nginx image
      community.docker.docker_image:
        name: nginx:latest
        source: pull
        tags: docker_run

    - name: Run nginx container
      community.docker.docker_container:
        name: nginx
        image: nginx:latest
        state: started
          ports:
            - "[::]:80:80"  # By default, docker is exposing ports on Ipv4, so we need set Ipv6 explicity.
        tags: docker_run
```

## Ansible Vault

Ansible Vault is a feature of ansible that allows you to keep sensitive data such as passwords or keys in encrypted files, rather than as plaintext in playbooks or roles. These vault files can then be distributed or placed in source control.

https://docs.ansible.com/ansible/2.9/user_guide/vault.html#id6

### Creating Encrypted Files

To create a new encrypted data file, run the following command:

`ansible-vault create foo.yml`

To create a new encrypted data file with the Vault ID ‘password1’ assigned to it and be prompted for the password, run:

`ansible-vault create --vault-id password1@prompt foo.yml`

### Editing Encrypted Files

To edit an encrypted file in place, use the ansible-vault edit command. This command will decrypt the file to a temporary file and allow you to edit the file, saving it back when done and removing the temporary file:

`ansible-vault edit foo.yml`

To edit a file encrypted with the ‘vault2’ password file and assigned the ‘pass2’ vault ID:

`ansible-vault edit --vault-id pass2@vault2 foo.yml`

### Rekeying Encrypted Files

Should you wish to change your password on a vault-encrypted file or files, you can do so with the rekey command:

`ansible-vault rekey foo.yml bar.yml baz.yml`

To rekey files encrypted with the ‘preprod2’ vault ID and the ‘ppold’ file and be prompted for the new password:

`ansible-vault rekey --vault-id preprod2@ppold --new-vault-id preprod2@prompt foo.yml bar.yml baz.yml`

A different ID could have been set for the rekeyed files by passing it to `--new-vault-id`.

### Encrypting Unencrypted Files

If you have existing files that you wish to encrypt, use the ansible-vault encrypt command. This command can operate on multiple files at once:

`ansible-vault encrypt foo.yml bar.yml baz.yml`
To encrypt existing files with the ‘project’ ID and be prompted for the password:

`ansible-vault encrypt --vault-id project@prompt foo.yml bar.yml baz.yml`

### Decrypting Encrypted Files

If you have existing files that you no longer want to keep encrypted, you can permanently decrypt them by running the ansible-vault decrypt command. This command will save them unencrypted to the disk, so be sure you do not want ansible-vault edit instead:

`ansible-vault decrypt foo.yml bar.yml baz.yml`

### Viewing Encrypted Files

If you want to view the contents of an encrypted file without editing it, you can use the ansible-vault view command:

`ansible-vault view foo.yml bar.yml baz.yml`


## Use encrypt_string to create encrypted variables to embed in yaml

To encrypt a string provided as a cli arg:

`ansible-vault encrypt_string --vault-password-file a_password_file 'foobar' --name 'the_secret'`

To use a vault-id label for ‘dev’ vault-id:

`ansible-vault encrypt_string --vault-id dev@a_password_file 'foooodev' --name 'the_dev_secret'`

To encrypt a string read from stdin and name it ‘db_password’:

`echo -n 'letmein' | ansible-vault encrypt_string --vault-id dev@a_password_file --stdin-name 'db_password'`

## Providing Vault Passwords

When all data is encrypted using a single password the --ask-vault-pass or --vault-password-file cli options should be used.

For example, to use a password store in the text file /path/to/my/vault-password-file:

`ansible-playbook --vault-password-file /path/to/my/vault-password-file site.yml`

To prompt for a password:

`ansible-playbook --ask-vault-pass site.yml`

To get the password from a vault password executable script my-vault-password.py:

`ansible-playbook --vault-password-file my-vault-password.py`

The `--vault-id` option can also be used without specifying a vault-id. This behaviour is equivalent to --ask-vault-pass or --vault-password-file so is rarely used.

For example, to use a password file dev-password:

`ansible-playbook --vault-id dev-password site.yml`

To prompt for the password:

`ansible-playbook --vault-id @prompt site.yml`

To get the password from an executable script my-vault-password.py:

`ansible-playbook --vault-id my-vault-password.py`

## Ansible Lint

Ansible Lint is a command-line tool for linting playbooks, roles and collections aimed toward any Ansible users. Its main goal is to promote proven practices, patterns and behaviors while avoiding common pitfalls that can easily lead to bugs or make code harder to maintain.

https://ansible-lint.readthedocs.io/
https://www.redhat.com/sysadmin/ansible-lint-YAML


## Examples Playbooks

https://github.com/ansible/ansible-examples

## Tips 

https://www.redhat.com/sysadmin/ansible-guides

### Running on local machine 

Add to inventory file snippet:

`local ansible_connection=local` 

This will call local machine, without ssh call.

## Glossary

block - blocks create logical groups of tasks. Blocks also offer ways to handle task errors, similar to exception handling in many programming languages. https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_blocks.html#blocks


failed_when - conditional that defines what `failure` means in each task.  https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_error_handling.html#defining-failure

register - You can create variables from the output of an Ansible task with the task keyword register. You can use registered variables in any later tasks in your play. https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html#registering-variables

